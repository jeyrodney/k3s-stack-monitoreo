apiVersion: v1
data:
  alert_rules.yml: |
    groups:

      - name: branch_ping_alerts
        rules:
        
          # Alerta de sucursal caída
          - alert: BranchDown
            expr: avg_over_time(probe_success[1m]) == 0
            for: 1m
            labels:
              severity: critical
            annotations:
              summary: "Switch caído: {{ $labels.branch }}"
              description: "Pérdida total del 100% en Switch: {{ $labels.branch }} ({{ $labels.instance }})."
              
          # Alerta de pérdida de paquetes para ICMP
          - alert: HighPacketLoss
            expr: (1 - avg_over_time(probe_success{branch=~".*"}[10m])) * 100 > 10 and avg_over_time(probe_success{branch=~".*"}[10m]) < 0.90 and avg_over_time(probe_success{branch=~".*"}[10m]) > 0.10
            for: 10m
            #keep_firing_for: 1m
            labels:
              severity: warning
            annotations:
              summary: "Perdida de paquetes detectada en SW: {{ $labels.branch }}"
              description: "Perdida de paquetes supera 10%, ultimos 5 minutos: {{ $labels.branch }} ({{ $labels.instance }})."

          # Alerta de alta latencia para ICMP
          - alert: HighLatency
            expr: avg_over_time(probe_icmp_duration_seconds{phase="rtt"}[5m]) > 0.3
            #expr: probe_success == 1 and (avg_over_time(probe_duration_seconds{job="blackbox-icmp"}[3m]) > 0.3)
            for: 5m
            #keep_firing_for: 1m
            labels:
              severity: warning
            annotations:
              summary: "Alta latencia detectada en SW: {{ $labels.branch }}"
              description: "Latencia supera 300ms, ultimos 5 minutos: {{ $labels.branch }} ({{ $labels.instance }})."

          # Alerta del tablero 'Promedio de Pérdida de paquetes Sucursalas', si hay mas de 5% durante 5minutos, indica que hay varias sucursales con perdidas
          - alert: AnomaliaRedSucursales
            expr: (1 - avg(avg_over_time(probe_success{branch=~".*"}[5m]))) * 100 > 5
            for: 5m
            labels:
              severity: critical
            annotations:
              summary: "URGENTE: Pérdida de paquetes en varias sucursales"
              description: "Se detectó pérdida de paquetes superior al 5% en las últimas 5 minutos en varias sucursales."

  prometheus.yml: |
    global:
      scrape_interval:     15s # Set the scrape interval to every 15 seconds. Default is every 1 minute.
      evaluation_interval: 15s # Evaluate rules every 15 seconds. The default is every 1 minute.

    alerting:
      alertmanagers:
        - static_configs:
            - targets:
              - alertmanager:9093

    # Alertmanager configuration
    # Load rules once and periodically evaluate them according to the global 'evaluation_interval'.
    rule_files:
        - "alert_rules.yml"

    scrape_configs:
      - job_name: 'prometheus'
        static_configs:
        - targets: ['prometheus:9090']
        
      - job_name: 'cadvisor'
        static_configs:
        - targets: ['cadvisor:8080']

      - job_name: 'node-exporter'
        static_configs:
        - targets: ['node-exporter:9100']

      - job_name: "blackbox-icmp"
        scrape_interval: 5s
        metrics_path: /probe
        params:
          module: [icmp]
        static_configs:
          - targets: [office365.com]
            labels:
              branch: "office365"
              ###
          - targets: [semana.com]
            labels:
              branch: "semana.com"
              ###
          - targets: [74.6.143.25]
            labels:
              branch: "yahoo.com"
              ###
          - targets: [52.123.247.31]
            labels:
              branch: "teams.office.com"
              ###
          - targets: [192.168.1.254]
            labels:
              branch: "Puerta de Enlace Casa"
              ###
          - targets: [192.168.1.65]
            labels:
              branch: "Portatil"
              ###
          - targets: [8.8.8.8]
            labels:
              branch: "Google"
              ###
          - targets: [1.1.1.1]
            labels:
              branch: "1.1.1.1"
              ###
          - targets: [8.8.1.1]
            labels:
              branch: "8.8.1.1"
              ###
          - targets: [163.116.226.35]
            labels:
              branch: "163.116.226.35_Netskope"
              ###
          #- targets: [192.168.1.3]
            #labels:
              #branch: "celjey"
              ###
          - targets: [52.129.99.253]
            labels:
              branch: "52.129.99.253 Genesys 1 Casa"
              ###
          - targets: [52.129.99.254]
            labels:
              branch: "52.129.99.254 Genesys 2 Casa"
              ###
          - targets: [52.129.99.255]
            labels:
              branch: "52.129.99.255 Genesys 3 Casa"
              ###

        relabel_configs:
          - source_labels: [__address__]
            target_label: __param_target
          - source_labels: [__param_target]
            target_label: instance
          - target_label: __address__
            replacement: blackbox:9115 # The blackbox exporter's real hostname:port.
            
      - job_name: 'blackbox_exporter'  # collect blackbox exporter's operational metrics.
        static_configs:
          - targets: ['blackbox:9115']


kind: ConfigMap
metadata:
  creationTimestamp: null
  name: prometheus-config
  namespace: monitoring
